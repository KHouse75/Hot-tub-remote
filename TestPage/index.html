<html>
	<head>
		<title>Hot tub remote test page</title>
	</head>
	<body>
		<div>
		Ip: <span id='ipAddress'></span>
		</div>

		<div>
			Heater
			<button onclick='device("heater", true)')>On</button>
			<button onclick='device("heater", false)')>Off</button>
		<div>

		<div>
			Pump
			<button onclick='device("pump", true)'>On</button>
			<button onclick='device("pump", false)'>Off</button>
		</div>

		<div>
			Blower
			<button onclick='device("blower", true)'>On</button>
			<button onclick='device("blower", false)'>Off</button><br />
		</div>

		<div>
			<button onclick='sendCommand("0x3A30");'>Temp Up</button><br />
		</div>

		<div>
			<button onclick='sendCommand("0x3840");'>Temp Down</button><br />
		</div>

		<div>
			<button onclick='getStatus()'>Get Status</button>
		</div>

		<div>
			<pre id="response" style="border: solid black 1px;"></pre>
		</div>

		<script type="text/javascript">
			(function() {
		
				const DEFAULT_IP = '192.168.0.44';
			
				const ip = getIp();
				
				document.getElementById('ipAddress').innerHTML = ip;
			
				function getIp() {
					const urlParams = new URLSearchParams(location.search);

					const ip = urlParams.has('ip')
						? urlParams.get('ip')
						: DEFAULT_IP;
						
					const regex = /^(?:(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])(\.(?!$)|$)){4}$/gm;
					
					
					return ip.match(regex)
						? ip
						: DEFAULT_IP;
						
					return ip;
				}
			
				async function sendCommand(command) {
					await post(`command?command=${command}`);
				}
			
				async function post(uri) {
					return await http(uri, 'POST');
				}
			
				async function http(uri, method) {
					try {
						var response = await fetch(`http://${ip}/${uri}`, {	
							method: 'POST', 
							mode: 'cors',
							cache: 'no-cache',
							headers: {
								'Content-Type': 'text/plain',
							}
						});
				
						var data = response.ok ? (JSON.stringify(await response.json(), null, 2)) : "ERROR: " + response.statusText;
						document.getElementById("response").innerHTML = data;
						
					} catch(err) {
						alert(err);
					}		
				}				
					
				async function device(deviceType, state) {
					await post(`${deviceType}?state=${state}`);
				}

				async function getStatus() {
					await http('status', 'GET');
				}
			
			})();
		</script>
	</body>
</html>